#define DEFAULT_MQTT_HOST "mqtt1.eoh.io"
#define ERA_AUTH_TOKEN "a3f00619-a76e-41f7-8104-c3fc3891c81a"

#include <Arduino.h>
#include <ERa.hpp>
#include <Wire.h>
#include <LiquidCrystal_I2C.h>
#define byte uint8_t
#include <Keypad.h>
#include <DHT.h>

// ================= WIFI =================
const char ssid[] = "Redmi Note";
const char pass[] = "1234567890";

// ================= LCD =================
LiquidCrystal_I2C lcd(0x27, 16, 2);

// ================= PASSWORD =================
const String MASTER_PASS = "1234";
String inputPassword = "";

// ================= STATE =================
bool manualPumpState = false;
bool isAuthMode = false;
bool isMenuMode = false;
bool stopAlarm = false;

// Slide show
int currentPage = 0;
unsigned long lastPageSwitch = 0;
const int PAGE_DELAY = 3000;

// ================= SENSOR =================
#define PIN_DHT_IN 33
#define PIN_DHT_OUT 25
#define DHTTYPE DHT11
DHT dhtIn(PIN_DHT_IN, DHTTYPE);
DHT dhtOut(PIN_DHT_OUT, DHTTYPE);

// Ultrasonic fuel
#define TRIG_PIN 32
#define ECHO_PIN 35
const int H_BE_CAN = 100;
const int H_BE_DAY = 5;
int currentFuelPct = 0;

#define MQ2_PIN 34
#define PIR_PIN 39

const int GAS_LIMIT = 800;
const int TEMP_LIMIT = 55;

// ================= OUTPUT =================
#define RELAY_PIN 23
#define BUZZER_PIN 26
#define RED_LED 27
#define GREEN_LED 14

// ================= KEYPAD =================
const byte ROWS = 4;
const byte COLS = 3;
char keys[ROWS][COLS] = {
  {'1','2','3'},
  {'4','5','6'},
  {'7','8','9'},
  {'*','0','#'}
};
byte rowPins[ROWS] = {15, 4, 16, 17};
byte colPins[COLS] = {5, 18, 19};
Keypad keypad = Keypad(makeKeymap(keys), rowPins, colPins, ROWS, COLS);

// ================= SYSTEM =================
bool isFireDanger = false;
bool isIntruder = false;
unsigned long lastSensorTime = 0;

// ================= ERA =================
WiFiClient mbTcpClient;

// ================= ERA VIRTUAL =================
ERA_WRITE(V6) {
  manualPumpState = param.getInt();
  if (!isFireDanger || stopAlarm)
    digitalWrite(RELAY_PIN, manualPumpState ? HIGH : LOW);
}

ERA_WRITE(V7) {
  stopAlarm = param.getInt();
  if (stopAlarm) digitalWrite(BUZZER_PIN, LOW);
}

// ================= SETUP =================
void setup() {
  Serial.begin(115200);
  Serial.println("\n===== HE THONG KHOI DONG =====");

  ERa.setModbusClient(mbTcpClient);
  ERa.setScanWiFi(true);
  ERa.begin(ssid, pass);

  lcd.init();
  lcd.backlight();
  lcd.setCursor(0,0);
  lcd.print("HE THONG");
  lcd.setCursor(0,1);
  lcd.print("KHOI DONG...");
  delay(2000);
  lcd.clear();

  dhtIn.begin();
  dhtOut.begin();

  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);
  pinMode(MQ2_PIN, INPUT);
  pinMode(PIR_PIN, INPUT);

  pinMode(RELAY_PIN, OUTPUT);
  pinMode(BUZZER_PIN, OUTPUT);
  pinMode(RED_LED, OUTPUT);
  pinMode(GREEN_LED, OUTPUT);

  digitalWrite(RELAY_PIN, LOW);
  digitalWrite(GREEN_LED, HIGH);
}

// ================= LOOP =================
void loop() {
  ERa.run();

  char key = keypad.getKey();
  if (key) {
    xuLyBanPhim(key);
    hienThiLCD();
  }

  if (millis() - lastSensorTime > 1500) {
    lastSensorTime = millis();
    docCamBienVaXuLy();
    hienThiLCD();
    hienThiSerial();
  }

  if (!isMenuMode && !isAuthMode && !isFireDanger && !isIntruder &&
      millis() - lastPageSwitch > PAGE_DELAY) {
    lastPageSwitch = millis();
    currentPage = (currentPage + 1) % 3;
    hienThiLCD();
  }
}

// ================= FUEL =================
int docPhanTramXang() {
  long duration;
  float total = 0;
  for (int i = 0; i < 5; i++) {
    digitalWrite(TRIG_PIN, LOW); delayMicroseconds(2);
    digitalWrite(TRIG_PIN, HIGH); delayMicroseconds(10);
    digitalWrite(TRIG_PIN, LOW);
    duration = pulseIn(ECHO_PIN, HIGH, 30000);
    total += (duration == 0) ? H_BE_CAN : (duration * 0.034 / 2);
    delay(5);
  }
  int pct = map(total / 5, H_BE_CAN, H_BE_DAY, 0, 100);
  return constrain(pct, 0, 100);
}

// ================= KEYPAD =================
void xuLyBanPhim(char key) {
  Serial.print("Phim: "); Serial.println(key);

  if (isMenuMode) {
    if (key == '1') stopAlarm = !stopAlarm;
    else if (key == '2') manualPumpState = !manualPumpState;
    else if (key == '#') isMenuMode = false;
    return;
  }

  if (key == '*') {
    isAuthMode = true;
    inputPassword = "";
  }
  else if (key == '#') {
    isAuthMode = false;
    inputPassword = "";
  }
  else if (isAuthMode) {
    inputPassword += key;
    if (inputPassword.length() == 4) kiemTraMatKhau();
  }
}

void kiemTraMatKhau() {
  if (inputPassword == MASTER_PASS) {
    isMenuMode = true;
    Serial.println(">> DUNG MAT KHAU");
  } else {
    Serial.println(">> SAI MAT KHAU");
    digitalWrite(BUZZER_PIN, HIGH);
    delay(300);
    digitalWrite(BUZZER_PIN, LOW);
  }
  isAuthMode = false;
  inputPassword = "";
}

// ================= SENSOR & LOGIC =================
void docCamBienVaXuLy() {
  float tIn = dhtIn.readTemperature();
  float tOut = dhtOut.readTemperature();
  int gas = analogRead(MQ2_PIN);
  bool motion = digitalRead(PIR_PIN);

  currentFuelPct = docPhanTramXang();

  if (gas > GAS_LIMIT || tIn > TEMP_LIMIT || tOut > TEMP_LIMIT) {
    isFireDanger = true;
    isIntruder = false;
  } else if (motion) {
    isFireDanger = false;
    isIntruder = true;
  } else {
    isFireDanger = false;
    isIntruder = false;
  }

  if (isFireDanger) {
    digitalWrite(RELAY_PIN, HIGH);
    digitalWrite(BUZZER_PIN, stopAlarm ? LOW : HIGH);
    digitalWrite(RED_LED, HIGH);
    digitalWrite(GREEN_LED, LOW);
  }
  else if (isIntruder) {
    digitalWrite(RELAY_PIN, manualPumpState ? HIGH : LOW);
    digitalWrite(BUZZER_PIN, stopAlarm ? LOW : HIGH);
    digitalWrite(RED_LED, HIGH);
    digitalWrite(GREEN_LED, LOW);
  }
  else {
    stopAlarm = false;
    digitalWrite(RELAY_PIN, manualPumpState ? HIGH : LOW);
    digitalWrite(BUZZER_PIN, LOW);
    digitalWrite(RED_LED, LOW);
    digitalWrite(GREEN_LED, HIGH);
  }

  ERa.virtualWrite(V0, tIn);
  ERa.virtualWrite(V1, tOut);
  ERa.virtualWrite(V2, gas);
  ERa.virtualWrite(V3, currentFuelPct);
  ERa.virtualWrite(V4, isFireDanger);
  ERa.virtualWrite(V5, isIntruder);
}

// ================= LCD =================
void hienThiLCD() {
  lcd.clear();

  if (isMenuMode) {
    lcd.setCursor(0,0);
    lcd.print("1.Coi:");
    lcd.print(stopAlarm ? "OFF" : "ON ");
    lcd.setCursor(0,1);
    lcd.print("2.Bom:");
    lcd.print(manualPumpState ? "ON " : "OFF");
    return;
  }

  if (isAuthMode) {
    lcd.setCursor(0,0);
    lcd.print("NHAP MAT KHAU");
    lcd.setCursor(0,1);
    lcd.print(inputPassword);
    return;
  }

  if (isFireDanger) {
    lcd.setCursor(0,0);
    lcd.print("!! NGUY HIEM !!");
    lcd.setCursor(0,1);
    lcd.print("CHAY/GAS CAO");
    return;
  }

  if (isIntruder) {
    lcd.setCursor(0,0);
    lcd.print("!! CANH BAO !!");
    lcd.setCursor(0,1);
    lcd.print("CO NGUOI!");
    return;
  }

  switch (currentPage) {
    case 0:
      lcd.setCursor(0,0);
      lcd.print("T.In:");
      lcd.print((int)dhtIn.readTemperature());
      lcd.print("C");
      lcd.setCursor(0,1);
      lcd.print("T.Out:");
      lcd.print((int)dhtOut.readTemperature());
      lcd.print("C");
      break;

    case 1:
      lcd.setCursor(0,0);
      lcd.print("Gas:");
      lcd.print(analogRead(MQ2_PIN));
      lcd.setCursor(0,1);
      lcd.print("Xang:");
      lcd.print(currentFuelPct);
      lcd.print("%");
      break;

    case 2:
      lcd.setCursor(0,0);
      lcd.print("Bom:");
      lcd.print(manualPumpState ? "ON " : "OFF");
      lcd.setCursor(0,1);
      lcd.print("Trang thai OK");
      break;
  }
}

// ================= SERIAL =================
void hienThiSerial() {
  Serial.println("\n===== TRANG THAI =====");
  Serial.print("T.In  : "); Serial.println(dhtIn.readTemperature());
  Serial.print("T.Out : "); Serial.println(dhtOut.readTemperature());
  Serial.print("Gas   : "); Serial.println(analogRead(MQ2_PIN));
  Serial.print("Xang  : "); Serial.print(currentFuelPct); Serial.println("%");
  Serial.print("Chay  : "); Serial.println(isFireDanger ? "YES" : "NO");
  Serial.print("Nguoi : "); Serial.println(isIntruder ? "YES" : "NO");
  Serial.print("Bom   : "); Serial.println(manualPumpState ? "ON" : "OFF");
  Serial.print("CoiOff: "); Serial.println(stopAlarm ? "YES" : "NO");
}


